#!/usr/bin/env bash
# Per-core CPU usage with optimized caching to avoid blocking sleep
# Uses previous run's data if available, only sleeps on first run

CACHE_FILE="/tmp/eww_cpu_cores_cache_${USER}"

# Read current CPU stats
readarray -t current < <(grep -E '^cpu[0-9]+' /proc/stat)

# Check if we have cached data from previous run
if [[ -f "$CACHE_FILE" ]]; then
    # Use cached data from previous poll
    readarray -t previous < "$CACHE_FILE"

    # If cache has same number of cores, use it
    if [[ ${#previous[@]} -eq ${#current[@]} ]]; then
        out=()
        for i in "${!current[@]}"; do
            read -ra f1 <<< "${previous[i]}"
            read -ra f2 <<< "${current[i]}"
            # fields: cpuN user nice system idle iowait irq softirq steal
            t1=$(( ${f1[1]}+${f1[2]}+${f1[3]}+${f1[4]}+${f1[5]}+${f1[6]}+${f1[7]}+${f1[8]} ))
            t2=$(( ${f2[1]}+${f2[2]}+${f2[3]}+${f2[4]}+${f2[5]}+${f2[6]}+${f2[7]}+${f2[8]} ))
            i1=$(( ${f1[4]}+${f1[5]} ))
            i2=$(( ${f2[4]}+${f2[5]} ))
            dt=$(( t2 - t1 ))
            di=$(( i2 - i1 ))
            use=$(( dt > 0 ? (100*(dt - di))/dt : 0 ))
            out+=( "C${i} ${use}%" )
        done

        # Save current stats for next run
        printf "%s\n" "${current[@]}" > "$CACHE_FILE"

        # Output results
        printf "%s\n" "${out[@]}"
        exit 0
    fi
fi

# First run or cache invalid - need to sleep once
readarray -t a < <(grep -E '^cpu[0-9]+' /proc/stat)
sleep 0.5
readarray -t b < <(grep -E '^cpu[0-9]+' /proc/stat)

out=()
for i in "${!a[@]}"; do
    read -ra f1 <<< "${a[i]}"
    read -ra f2 <<< "${b[i]}"
    t1=$(( ${f1[1]}+${f1[2]}+${f1[3]}+${f1[4]}+${f1[5]}+${f1[6]}+${f1[7]}+${f1[8]} ))
    t2=$(( ${f2[1]}+${f2[2]}+${f2[3]}+${f2[4]}+${f2[5]}+${f2[6]}+${f2[7]}+${f2[8]} ))
    i1=$(( ${f1[4]}+${f1[5]} ))
    i2=$(( ${f2[4]}+${f2[5]} ))
    dt=$(( t2 - t1 ))
    di=$(( i2 - i1 ))
    use=$(( dt > 0 ? (100*(dt - di))/dt : 0 ))
    out+=( "C${i} ${use}%" )
done

# Save for next run
printf "%s\n" "${b[@]}" > "$CACHE_FILE"

printf "%s\n" "${out[@]}"
